const dom={newTextNode:e=>document.createTextNode(e),newTag:(e,t,a)=>{t=t||{};const n=document.createElement(e);for(let e in t)"text"!=e&&(n[e]=t[e]);return t.text?n.textContent=t.text:t.childElement&&("object"==typeof t.childElement?t.childElement instanceof NodeList?Array.prototype.slice.call(t.childElement,0).forEach(e=>{n.appendChild(e)}):n.appendChild(t.childElement):n.appendChild(dom.newTextNode(t.childElement))),t.class&&(n.className=t.class),a&&(n.style.cssText=a),n},tableFactory:(e,t,a)=>{const n=dom.newTag("div",{id:e||"",class:"table-holder"}),o=dom.newTag("table"),r=dom.newTag("thead");return r.appendChild(t(dom.newTag("tr"))),o.appendChild(r),o.appendChild(a(dom.newTag("tbody"))),n.appendChild(o),n},combineNodes:(e,t)=>{const a=document.createElement("div");return"object"==typeof e?a.appendChild(e):"string"==typeof e&&a.appendChild(dom.newTextNode(e)),"object"==typeof t?a.appendChild(t):"string"==typeof t&&a.appendChild(dom.newTextNode(t)),a.childNodes},addClass:(e,t)=>(e.classList.add(t),e),removeClass:(e,t)=>(e.classList.remove(t),e)},helper={getFileType:(e,t)=>{if(e)switch(e){case"jpg":case"jpeg":case"png":case"gif":case"webp":case"svg":case"ico":return"image";case"js":return"js";case"css":return"css";case"html":return"html";case"woff":case"woff2":case"ttf":case"eot":case"otf":return"font";case"map":return"source-map"}if(t)switch(t){case"xmlhttprequest":return"ajax";case"img":return"image";case"script":return"js";case"internal":case"iframe":return"html";default:return"other"}return t},getRandomColor:(e,t,a)=>{const n=[e||"0123456789ABCDEF",t||"0123456789ABCDEF",a||"0123456789ABCDEF"];let o="#",r=0;for(let e=0;e<6;e++)r=Math.floor(e/2),o+=n[r].split("")[Math.floor(Math.random()*n[r].length)];return o},endsWith:(e,t)=>-1!==e.indexOf(t,e.length-t.length)},getColourVariation=(e,t)=>"#"+(parseInt(e.substr(1,2),16)+t).toString(16)+(parseInt(e.substr(3,2),16)+t).toString(16)+(parseInt(e.substr(5,2),16)+t).toString(16);helper.getInitiatorOrFileTypeColour=(e,t,a)=>{let n=t||"#bebebe";switch(e){case"css":n="#6b7ac7";break;case"iframe":case"html":n="#b86bc7";break;case"img":case"image":n="#c78a6b";break;case"script":case"js":n="#8a6bc7";break;case"link":n="#6bc7b8";break;case"font":n="#6ba8c7";break;case"xmlhttprequest":case"ajax":n="#c76b8a"}return!0===a?getColourVariation(n,-5):n},helper.getItemCount=(e,t)=>{let a,n={},o=[];e.forEach(e=>{n[e]=n[e]?n[e]+1:1});for(let e in n)a={},a[t||"key"]=e,a.count=n[e],o.push(a);return o.sort((e,t)=>e.count<t.count?1:-1)},helper.clone=e=>{let t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(let a=0,n=e.length;a<n;a++)t[a]=helper.clone(e[a]);return t}if(e instanceof Object){t={};for(let a in e)e.hasOwnProperty(a)&&(t[a]=helper.clone(e[a]));return t}throw new Error("Unable to helper.clone obj")};let isValid=!0;const data={resources:[],marks:[],measures:[],perfTiming:[],allResourcesCalc:[],isValid:()=>isValid},supportsFeatures=()=>{if(window.performance&&void 0!==window.performance.getEntriesByType)data.resources=window.performance.getEntriesByType("resource"),data.marks=window.performance.getEntriesByType("mark"),data.measures=window.performance.getEntriesByType("measure");else{if(!window.performance||void 0===window.performance.webkitGetEntriesByType)return alert("Oups, looks like this browser does not support the Resource Timing API\ncheck http://caniuse.com/#feat=resource-timing to see the ones supporting it \n\n"),!1;data.resources=window.performance.webkitGetEntriesByType("resource"),data.marks=window.performance.webkitGetEntriesByType("mark"),data.measures=window.performance.webkitGetEntriesByType("measure")}return window.performance.timing?(data.perfTiming=window.performance.timing,!(data.perfTiming.loadEventEnd-data.perfTiming.navigationStart<0)||(alert("Page is still loading - please try again when page is loaded."),!1)):(alert("Oups, looks like this browser does not support performance timing"),!1)};!function(){isValid=supportsFeatures(),data.allResourcesCalc=data.resources.filter(e=>!e.name.match(/http[s]?\:\/\/(micmro|nurun).github.io\/performance-bookmarklet\/.*/)).map((e,t,a)=>{let n,o,r;0===e.name.indexOf("http")?(n=e.name.match(/:\/\/(.[^/]+)([^?]*)\??(.*)/),o=n[2].split("/").pop(),r=o.substr((Math.max(0,o.lastIndexOf("."))||1/0)+1)):(n=["",location.host],r=e.name.split(":")[0]);const i={name:e.name,domain:n[1],initiatorType:e.initiatorType||r||"SourceMap or Not Defined",fileExtension:r||"XHR or Not Defined",loadtime:e.duration,fileType:helper.getFileType(r,e.initiatorType),isRequestToHost:n[1]===location.host};for(let t in e)"function"!=typeof e[t]&&(i[t]=e[t]);return e.requestStart&&(i.requestStartDelay=e.requestStart-e.startTime,i.dns=e.domainLookupEnd-e.domainLookupStart,i.tcp=e.connectEnd-e.connectStart,i.ttfb=e.responseStart-e.startTime,i.requestDuration=e.responseStart-e.requestStart),e.secureConnectionStart&&(i.ssl=e.connectEnd-e.secureConnectionStart),i}),data.requestsOnly=data.allResourcesCalc.filter(e=>0===e.name.indexOf("http")&&!e.name.match(/js.map$/)),data.initiatorTypeCounts=helper.getItemCount(data.requestsOnly.map((e,t,a)=>e.initiatorType||e.fileExtension),"initiatorType"),data.initiatorTypeCountHostExt=helper.getItemCount(data.requestsOnly.map((e,t,a)=>(e.initiatorType||e.fileExtension)+" "+(e.isRequestToHost?"(host)":"(external)")),"initiatorType"),data.requestsByDomain=helper.getItemCount(data.requestsOnly.map((e,t,a)=>e.domain),"domain"),data.fileTypeCountHostExt=helper.getItemCount(data.requestsOnly.map((e,t,a)=>e.fileType+" "+(e.isRequestToHost?"(host)":"(external)")),"fileType"),data.fileTypeCounts=helper.getItemCount(data.requestsOnly.map((e,t,a)=>e.fileType),"fileType");const e={};data.requestsOnly.forEach(t=>{const a=data.requestsByDomain.filter(e=>e.domain==t.domain)[0]||{},n=e[t.domain]||0;t.duration=a.duration||t.responseEnd-t.startTime,n<=t.startTime?a.durationTotalParallel=(a.durationTotalParallel||0)+t.duration:n<t.responseEnd&&(a.durationTotalParallel=(a.durationTotalParallel||0)+(t.responseEnd-n)),e[t.domain]=t.responseEnd||0,a.durationTotal=(a.durationTotal||0)+t.duration}),data.hostRequests=data.requestsOnly.filter(e=>e.domain===location.host).length,data.currAndSubdomainRequests=data.requestsOnly.filter(e=>e.domain.split(".").slice(-2).join(".")===location.host.split(".").slice(-2).join(".")).length,data.crossDocDomainRequests=data.requestsOnly.filter(e=>!helper.endsWith(e.domain,document.domain)).length,data.hostSubdomains=data.requestsByDomain.filter(e=>helper.endsWith(e.domain,location.host.split(".").slice(-2).join("."))&&e.domain!==location.host).length,data.slowestCalls=[],data.average=void 0,data.allResourcesCalc.length>0&&(data.slowestCalls=data.allResourcesCalc.filter(e=>e.name!==location.href).sort((e,t)=>t.duration-e.duration),data.average=Math.floor(data.slowestCalls.reduceRight((e,t)=>"number"!=typeof e?e.duration+t.duration:e+t.duration)/data.slowestCalls.length))}();const svg={newEl:(e,t,a)=>{const n=document.createElementNS("http://www.w3.org/2000/svg",e);t=t||{};for(let e in t)"text"!=e&&n.setAttribute(e,t[e]);return n.textContent=t.text||"",a&&(n.style.cssText=a),n},newTextEl:(e,t,a)=>svg.newEl("text",{fill:"#111",y:t,text:e},a||""),getNodeTextWidth:e=>{const t=svg.newEl("svg",{},"visibility:hidden;");t.appendChild(e),iFrameHolder.getOutputIFrame().body.appendChild(t);const a=e.getBBox().width;return t.parentNode.removeChild(t),a}},waterfall={timeBlock:(e,t,a,n,o,r)=>({name:e,start:t,end:a,total:"number"!=typeof t||"number"!=typeof a?void 0:a-t,cssClass:n,segments:o,rawResource:r})};waterfall.setupTimeLine=(e,t,a,n,o)=>{const r=e/100,i=t.filter(e=>"number"==typeof e.start&&"number"==typeof e.total).sort((e,t)=>(e.start||0)-(t.start||0)),l=a.length>0?a.reduce((e,t)=>Math.max("number"==typeof e?e:0,svg.getNodeTextWidth(svg.newTextEl(t.name,"0")))):0,s=32*(i.length+1),d=s+l+200,c=dom.newTag("section",{class:"resource-timing water-fall-holder chart-holder"}),p=svg.newEl("svg",{height:Math.floor(d),class:"water-fall-chart"}),m=svg.newEl("g",{class:"labels"}),u=svg.newEl("line",{x1:"0",y1:"0",x2:"0",y2:s,class:"line-end"}),g=svg.newEl("line",{x1:"0",y1:"0",x2:"0",y2:s,class:"line-start"}),h=e=>{const t=e.target;dom.addClass(t,"active");const a=t.x.baseVal.valueInSpecifiedUnits+t.width.baseVal.valueInSpecifiedUnits+"%",n=t.x.baseVal.valueInSpecifiedUnits+"%";u.x1.baseVal.valueAsString=a,u.x2.baseVal.valueAsString=a,g.x1.baseVal.valueAsString=n,g.x2.baseVal.valueAsString=n,dom.addClass(u,"active"),dom.addClass(g,"active"),t.parentNode.appendChild(u),t.parentNode.appendChild(g)},f=e=>{dom.removeClass(e.target,"active"),dom.removeClass(u,"active"),dom.removeClass(g,"active")},T=(e,t,a,n,o,i,l)=>{let s;const d=svg.newEl("rect",{width:e/r+"%",height:t-1,x:Math.round(a/r*100)/100+"%",y:n,class:(l&&l.length>0?"time-block":"segment")+" "+(o||"block-undefined")});return i&&d.appendChild(svg.newEl("title",{text:i})),d.addEventListener("mouseenter",h),d.addEventListener("mouseleave",f),l&&l.length>0?(s=svg.newEl("g"),s.appendChild(d),l.forEach(e=>{e.total>0&&"number"==typeof e.start&&s.appendChild(T(e.total,8,e.start||.001,n,e.cssClass,e.name+" ("+Math.round(e.start)+"ms - "+Math.round(e.end)+"ms | total: "+Math.round(e.total)+"ms)"))}),s):d};return p.appendChild((()=>{const t=svg.newEl("g",{class:"time-scale full-width"});for(let a=0,n=e/1e3,o=100/n;a<=n;a++){const e=svg.newTextEl(a+"sec",s);a>n-.2?(e.setAttribute("x",o*a-.5+"%"),e.setAttribute("text-anchor","end")):e.setAttribute("x",o*a+.5+"%");const r=svg.newEl("line",{x1:o*a+"%",y1:"0",x2:o*a+"%",y2:s});t.appendChild(r),t.appendChild(e)}return t})()),p.appendChild((()=>{const e=svg.newEl("g",{transform:"scale(1, 1)",class:"marker-holder"});return a.forEach((t,n)=>{const o=t.startTime/r,i=svg.newEl("g",{class:"mark-holder"}),l=svg.newEl("g",{class:"line-holder"}),d=svg.newEl("g",{class:"line-label-holder",x:o+"%"});t.x=o;const c=svg.newTextEl(t.name,s+50);c.setAttribute("x",o+"%"),l.appendChild(svg.newEl("line",{x1:o+"%",y1:0,x2:o+"%",y2:s})),a[n-1]&&t.x-a[n-1].x<1&&(c.setAttribute("x",a[n-1].x+1+"%"),t.x=a[n-1].x+1),l.appendChild(svg.newEl("line",{x1:o+"%",y1:s,x2:t.x+"%",y2:s+23}));let p=!1;c.addEventListener("mouseenter",e=>{p||(p=!0,dom.addClass(l,"active"),i.parentNode.appendChild(i))}),c.addEventListener("mouseleave",e=>{p=!1,dom.removeClass(l,"active")}),d.appendChild(c),i.appendChild(svg.newEl("title",{text:t.name+" ("+Math.round(t.startTime)+"ms)"})),i.appendChild(l),e.appendChild(i),i.appendChild(d)}),e})()),n.forEach((e,t)=>{p.appendChild((e=>{const t=svg.newEl("rect",{width:(e.total||1)/r+"%",height:s,x:(e.start||.001)/r+"%",y:0,class:e.cssClass||"block-undefined"});return t.appendChild(svg.newEl("title",{text:e.name})),t})(e))}),i.forEach((e,t)=>{const a=e.total||1,n=25*t;p.appendChild(T(a,25,e.start||.001,n,e.cssClass,e.name+" ("+e.start+"ms - "+e.end+"ms | total: "+e.total+"ms)",e.segments));const o=svg.newTextEl(e.name+" ("+Math.round(e.total)+"ms)",n+(e.segments?20:17));(e.total||1)/r>10&&svg.getNodeTextWidth(o)<200?(o.setAttribute("class","inner-label"),o.setAttribute("x",(e.start||.001)/r+.5+"%"),o.setAttribute("width",a/r+"%")):(e.start||.001)/r+a/r<80?o.setAttribute("x",(e.start||.001)/r+a/r+.5+"%"):(o.setAttribute("x",(e.start||.001)/r-.5+"%"),o.setAttribute("text-anchor","end")),o.style.opacity=e.name.match(/js.map$/)?"0.5":"1",m.appendChild(o)}),p.appendChild(m),o&&c.appendChild(dom.newTag("h1",{text:o})),c.appendChild(p),c};const pieChartHelpers={},unit=2*Math.PI/100,createWedge=(e,t,a,n,o,r)=>{const i=t/2,l=a+(n*unit-.001),s=a+(n/2*unit-.001),d=i+i*Math.sin(a),c=i-i*Math.cos(a),p=i+i*Math.sin(l),m=i-i*Math.cos(l),u=i+.85*i*Math.sin(s),g=i-.85*i*Math.cos(s),h="M "+i+","+i+" L "+d+","+c+" A "+i+","+i+" 0 "+(l-a>Math.PI?1:0)+" 1 "+p+","+m+" Z",f=svg.newEl("path",{id:e,d:h,fill:r});if(f.appendChild(svg.newEl("title",{text:o})),f.setAttribute("aria-labelledby",o),f.addEventListener("mouseenter",e=>{e.target.style.opacity="0.5",e.target.ownerDocument.getElementById(e.target.getAttribute("id")+"-table").style.filter="invert(1)"}),f.addEventListener("mouseleave",e=>{e.target.style.opacity="1",e.target.ownerDocument.getElementById(e.target.getAttribute("id")+"-table").style.filter="none"}),n>10){const e=svg.newTextEl(o,g);return s<Math.PI?e.setAttribute("x",u-svg.getNodeTextWidth(e)):e.setAttribute("x",u),{path:f,wedgeLabel:e,endAngle:l}}return{path:f,endAngle:l}},chartMaxHeight=(()=>{const e=.98*window.innerWidth-64;return e<700?350:e<800?e/2-72:e/3-72})();pieChartHelpers.createPieChart=(e,t)=>{let a=0;const n=svg.newEl("svg",{viewBox:"0 0 "+t+" "+t,class:"pie-chart"},"max-height:"+chartMaxHeight+"px;"),o=svg.newEl("g",{}),r=svg.newEl("g");return e.forEach(e=>{const n=createWedge(e.id,t,a,e.perc,e.label+" ("+e.count+")",e.colour||helper.getRandomColor());r.appendChild(n.path),a=n.endAngle,n.wedgeLabel&&o.appendChild(n.wedgeLabel)}),r.appendChild(svg.newEl("circle",{cx:t/2,cy:t/2,r:.05*t,fill:"#fff"})),n.appendChild(r),n.appendChild(o),n},pieChartHelpers.createChartTable=(e,t,a)=>(a=a||[{name:"Requests",field:"count"}],dom.tableFactory("",t=>(t.appendChild(dom.newTag("th",{text:e,class:"text-left"})),a.forEach(e=>{t.appendChild(dom.newTag("th",{text:e.name,class:"text-right"}))}),t.appendChild(dom.newTag("th",{text:"Percentage",class:"text-right"})),t),e=>(t.forEach(t=>{const n=dom.newTag("tr",{id:t.id+"-table"});n.appendChild(dom.newTag("td",{text:t.label})),a.forEach(e=>{n.appendChild(dom.newTag("td",{text:t[e.field].toString(),class:"text-right"}))}),n.appendChild(dom.newTag("td",{text:Number.parseFloat(t.perc).toPrecision(4)+"%",class:"text-right"})),e.appendChild(n)}),e)));const pieChartComponent={init:()=>{const e=dom.newTag("section",{class:"pie-charts-holder chart-holder"}),t=(t,a,n,o,r)=>{const i=dom.newTag("div",{class:"pie-chart-holder",id:r||""});i.appendChild(dom.newTag("h1",{text:t})),i.appendChild(pieChartHelpers.createPieChart(a,400)),i.appendChild(dom.newTag("p",{text:"Total Requests: "+data.requestsOnly.length})),n&&n.length&&n.forEach(e=>{i.appendChild(dom.newTag("p",{text:e}))}),i.appendChild(pieChartHelpers.createChartTable(t,a,o)),e.appendChild(i)},a=data.requestsOnly.length/100;return t("Requests by Domain",data.requestsByDomain.map(e=>{const t=helper.clone(e);return t.perc=t.count/a,t.label=t.domain,t.domain===location.host?t.colour="#0c0":t.domain.split(".").slice(-2).join(".")===location.host.split(".").slice(-2).join(".")?t.colour="#0a0":t.colour=helper.getRandomColor("56789abcdef","01234567","abcdef"),t.id="reqByDomain-"+t.label.replace(/[^a-zA-Z]/g,"-"),t.durationAverage=Math.round(t.durationTotal/t.count),t.durationTotal=Math.round(t.durationTotal),t.durationTotalParallel=Math.round(t.durationTotalParallel),t}),["Domains Total: "+data.requestsByDomain.length],[{name:"Requests",field:"count"},{name:"Avg. Duration",field:"durationAverage"},{name:"Duration Parallel",field:"durationTotalParallel"},{name:"Duration Sum",field:"durationTotal"}],"pie-request-by-domain"),t("Requests by Initiator Type",data.initiatorTypeCounts.map(e=>(e.perc=e.count/a,e.label=e.initiatorType,e.colour=helper.getInitiatorOrFileTypeColour(e.initiatorType,helper.getRandomColor("789abcdef","789abcdef","789abcdef")),e.id="reqByInitiatorType-"+e.label.replace(/[^a-zA-Z]/g,"-"),e))),t("Requests by Initiator Type",data.initiatorTypeCountHostExt.map(e=>{const t=e.initiatorType.split(" ");return e.perc=e.count/a,e.label=e.initiatorType,e.colour=helper.getInitiatorOrFileTypeColour(t[0],helper.getRandomColor("789abcdef","789abcdef","789abcdef"),"(host)"!==t[1]),e.id="reqByInitiatorTypeLocEx-"+e.label.replace(/[^a-zA-Z]/g,"-"),e}),["Requests to Host: "+data.hostRequests,"Host: "+location.host]),t("Requests by File Type",data.fileTypeCounts.map(e=>(e.perc=e.count/a,e.label=e.fileType,e.colour=helper.getInitiatorOrFileTypeColour(e.fileType,helper.getRandomColor("789abcdef","789abcdef","789abcdef")),e.id="reqByFileType-"+e.label.replace(/[^a-zA-Z]/g,"-"),e))),t("Requests by File Type",data.fileTypeCountHostExt.map(e=>{const t=e.fileType.split(" ");return e.perc=e.count/a,e.label=e.fileType,e.colour=helper.getInitiatorOrFileTypeColour(t[0],helper.getRandomColor("789abcdef","789abcdef","789abcdef"),"(host)"!==t[1]),e.id="reqByFileType-"+e.label.replace(/[^a-zA-Z]/g,"-"),e}),["Requests to Host: "+data.hostRequests,"Host: "+location.host]),e}},summaryTilesComponent={init:function(){var e=function(e,t){let a="string"==typeof e&&(e.includes("Requests")||e.includes("Domains")||e.includes("Subdomains"))?"request_tile":"time_tile";"string"==typeof e&&"TOTAL"===e&&(a="total_tile");var n=dom.newTag("dl",{class:"summary-tile "+a});return n.appendChild(dom.newTag("dt",{childElement:e})),n.appendChild(dom.newTag("dd",{childElement:t})),n};const t=(e,t,a)=>{e.appendChild(dom.newTag("dt",{childElement:t})),e.appendChild(dom.newTag("dd",{text:a}))},a=dom.newTag("section",{class:"tiles-holder chart-holder"}),n=dom.newTag("dl",{class:"summary-tile-appendix"});[e("Domains",data.requestsByDomain.length||"0"),e("Subdomains",data.hostSubdomains||"0"),e("Requests",data.requestsOnly.length||"0"),e("Requests to Host",data.hostRequests||"0"),e("Requests to Top & Subdomains",data.currAndSubdomainRequests||"0"),e("Time to First Byte",data.perfTiming.responseStart-data.perfTiming.navigationStart),e(dom.newTag("span",{text:"DOM Content Loading",title:"domLoading to domContentLoadedEventStart"}),data.perfTiming.domContentLoadedEventStart-data.perfTiming.domLoading),e(dom.newTag("span",{text:"DOM Processing",title:"domLoading to loadEventStart"}),data.perfTiming.domComplete-data.perfTiming.domLoading),e("TOTAL",data.perfTiming.loadEventEnd-data.perfTiming.navigationStart)].forEach(e=>{a.appendChild(e)}),data.allResourcesCalc.length>0&&(a.appendChild(e(dom.newTag("span",{title:data.slowestCalls[0].name,text:"Slowest Call"}),Math.floor(data.slowestCalls[0].duration))),a.appendChild(e("Average Call",data.average))),t(n,dom.newTextNode("Top Level Domain",location.host.split(".").slice(-2).join("."))),t(n,dom.newTextNode("host"),location.host),t(n,dom.newTextNode("document domain"),document.domain);var o=navigator.connection;if(o)for(var r in t(n,dom.newTextNode("Navigator connection"),""),o){var i=o[r];i&&"function"!=typeof i&&t(n,dom.newTextNode(r),i)}return a.appendChild(n),a}},navigationTimelineComponent={init:()=>{const e=data.perfTiming.navigationStart,t={pageLoadTime:data.perfTiming.loadEventEnd-data.perfTiming.navigationStart,output:[]};for(let a in data.perfTiming)data.perfTiming[a]&&"number"==typeof data.perfTiming[a]&&(t[a]=data.perfTiming[a]-e,t.output.push({name:a,time:data.perfTiming[a]-e}));return t.output.sort((e,t)=>(e.time||0)-(t.time||0)),t.blocks=[waterfall.timeBlock("Total",0,t.pageLoadTime,"block-total"),waterfall.timeBlock("Unload",t.unloadEventStart,t.unloadEventEnd,"block-unload"),waterfall.timeBlock("Redirect ("+performance.navigation.redirectCount+"x)",t.redirectStart,t.redirectEnd,"block-redirect"),waterfall.timeBlock("App cache",t.fetchStart,t.domainLookupStart,"block-appcache"),waterfall.timeBlock("DNS",t.domainLookupStart,t.domainLookupEnd,"block-dns"),waterfall.timeBlock("TCP",t.connectStart,t.connectEnd,"block-tcp"),waterfall.timeBlock("Time to First Byte",t.requestStart,t.responseStart,"block-ttfb"),waterfall.timeBlock("Response",t.responseStart,t.responseEnd,"block-response"),waterfall.timeBlock("DOM Processing",t.domLoading,t.domComplete,"block-dom"),waterfall.timeBlock("domContentLoaded Event",t.domContentLoadedEventStart,t.domContentLoadedEventEnd,"block-dom-content-loaded"),waterfall.timeBlock("onload Event",t.loadEventStart,t.loadEventEnd,"block-onload")],t.secureConnectionStart&&t.blocks.push(waterfall.timeBlock("SSL",t.connectStart,t.secureConnectionStart,"block-ssl")),t.msFirstPaint&&t.blocks.push(waterfall.timeBlock("msFirstPaint Event",t.msFirstPaint,t.msFirstPaint,"block-ms-first-paint-event")),t.domInteractive&&t.blocks.push(waterfall.timeBlock("domInteractive Event",t.domInteractive,t.domInteractive,"block-dom-interactive-event")),!t.redirectEnd&&!t.redirectStart&&t.fetchStart>t.navigationStart&&t.blocks.push(waterfall.timeBlock("Cross-Domain Redirect (and/or other Delay)",t.navigationStart,t.fetchStart,"block-redirect")),t.blocks.push(waterfall.timeBlock("Network/Server",t.navigationStart,t.responseStart,"block-network-server")),data.measures.forEach(e=>{t.blocks.push(waterfall.timeBlock("measure:"+e.name,Math.round(e.startTime),Math.round(e.startTime+e.duration),"block-custom-measure"))}),tableLogger.logTables([{name:"Navigation Timeline",data:t.blocks,columns:["name","start","end","total"]},{name:"Navigation Events",data:t.output},{name:"Marks",data:data.marks,columns:["name","startTime","duration"]}]),waterfall.setupTimeLine(Math.round(t.pageLoadTime),t.blocks,data.marks,[],"Navigation Timing")}},resourcesTimelineComponent={},getChartData=e=>{const t={pageLoadTime:data.perfTiming.loadEventEnd-data.perfTiming.responseStart,lastResponseEnd:data.perfTiming.loadEventEnd-data.perfTiming.responseStart};for(let e in data.perfTiming)data.perfTiming[e]&&"number"==typeof data.perfTiming[e]&&(t[e]=data.perfTiming[e]-data.perfTiming.navigationStart);const a=waterfall.timeBlock("domContentLoaded Event",t.domContentLoadedEventStart,t.domContentLoadedEventEnd,"block-dom-content-loaded"),n=waterfall.timeBlock("Onload Event",t.loadEventStart,t.loadEventEnd,"block-onload"),o=[waterfall.timeBlock("Unload",t.unloadEventStart,t.unloadEventEnd,"block-unload"),waterfall.timeBlock("Redirect",t.redirectStart,t.redirectEnd,"block-redirect"),waterfall.timeBlock("App cache",t.fetchStart,t.domainLookupStart,"block-appcache"),waterfall.timeBlock("DNS",t.domainLookupStart,t.domainLookupEnd,"block-dns"),waterfall.timeBlock("TCP",t.connectStart,t.connectEnd,"block-tcp"),waterfall.timeBlock("Timer to First Byte",t.requestStart,t.responseStart,"block-ttfb"),waterfall.timeBlock("Response",t.responseStart,t.responseEnd,"block-response"),waterfall.timeBlock("DOM Processing",t.domLoading,t.domComplete,"block-dom"),a,n];return t.secureConnectionStart&&o.push(waterfall.timeBlock("SSL",t.connectStart,t.secureConnectionStart,"block-ssl")),t.msFirstPaint&&o.push(waterfall.timeBlock("msFirstPaint Event",t.msFirstPaint,t.msFirstPaint,"block-ms-first-paint-event")),t.domInteractive&&o.push(waterfall.timeBlock("domInteractive Event",t.domInteractive,t.domInteractive,"block-dom-interactive-event")),!t.redirectEnd&&!t.redirectStart&&t.fetchStart>t.navigationStart&&o.push(waterfall.timeBlock("Cross-Domain Redirect",t.navigationStart,t.fetchStart,"block-redirect")),t.blocks=[waterfall.timeBlock("Navigation API total",0,t.loadEventEnd,"block-navigation-api-total",o)],data.allResourcesCalc.filter(e=>e.startTime<t.loadEventEnd+15e3).filter(e||(()=>!0)).forEach((e,a)=>{const n=[waterfall.timeBlock("Redirect",e.redirectStart,e.redirectEnd,"block-redirect"),waterfall.timeBlock("DNS Lookup",e.domainLookupStart,e.domainLookupEnd,"block-dns"),waterfall.timeBlock("Initial Connection (TCP)",e.connectStart,e.connectEnd,"block-dns"),waterfall.timeBlock("secureConnect",e.secureConnectionStart||void 0,e.connectEnd,"block-ssl"),waterfall.timeBlock("Timer to First Byte",e.requestStart,e.responseStart,"block-ttfb"),waterfall.timeBlock("Content Download",e.responseStart||void 0,e.responseEnd,"block-response")],o=[0,e.redirectStart,e.domainLookupStart,e.connectStart,e.secureConnectionStart,e.requestStart,e.responseStart].reduce((t,a)=>a>0&&(a<t||t<=0)&&a!=e.startTime?a:t);e.startTime<o&&n.unshift(waterfall.timeBlock("Stalled/Blocking",e.startTime,o,"block-blocking")),t.blocks.push(waterfall.timeBlock(e.name,e.startTime,e.responseEnd,"block-"+e.initiatorType,n,e)),t.lastResponseEnd=Math.max(t.lastResponseEnd,e.responseEnd)}),{loadDuration:Math.round(Math.max(t.lastResponseEnd,data.perfTiming.loadEventEnd-data.perfTiming.navigationStart)),blocks:t.blocks,bg:[a,n]}};resourcesTimelineComponent.init=()=>{let e=getChartData();const t=waterfall.setupTimeLine(e.loadDuration,e.blocks,data.marks,e.bg,"Resource Timing");if(data.requestsByDomain.length>1){const a=dom.newTag("select",{class:"domain-selector",onchange:()=>{const n=a.options[a.selectedIndex].value;e="all"===n?getChartData():getChartData(e=>e.domain===n);const o=waterfall.setupTimeLine(e.loadDuration,e.blocks,data.marks,e.bg,"Temp"),r=t.getElementsByClassName("water-fall-chart")[0],i=o.getElementsByClassName("water-fall-chart")[0];t.replaceChild(i,r)}});a.appendChild(dom.newTag("option",{text:"show all",value:"all"})),data.requestsByDomain.forEach(e=>{a.appendChild(dom.newTag("option",{text:e.domain}))});const n=t.getElementsByClassName("water-fall-chart")[0];n.parentNode.insertBefore(a,n)}return t};const pageMetricComponent={init:()=>{const e=persistance.persistanceEnabled(),t=dom.newTag("section",{class:"page-metric chart-holder"});t.appendChild(dom.newTag("h3",{text:"Persist Data"}));const a=dom.newTag("label",{text:" Persist Data?"}),n=dom.newTag("input",{type:"checkbox",id:"persist-data-checkbox",checked:e}),o=dom.newTag("button",{text:"Dumb data to console",disabled:!e});return n.addEventListener("change",e=>{e.target.checked?(persistance.activatePersistance(),o.disabled=!1):window.confirm("this will wipe out all stored data")?(persistance.deactivatePersistance(),o.disabled=!0):e.target.checked=!0}),a.insertBefore(n,a.firstChild),o.addEventListener("click",e=>{persistance.dump(!1)}),t.appendChild(a),t.appendChild(o),e&&persistance.saveLatestMetrics(),t}},legendComponent={},createLegend=(e,t,a)=>{const n=dom.newTag("div",{class:"legend-holder"});n.appendChild(dom.newTag("h4",{text:t}));const o=dom.newTag("ul",{class:"legend_color "+e});return a.forEach(e=>{o.appendChild(dom.newTag("li",{title:e[0],style:"background-color:"+e[1]}))}),n.appendChild(o),n};legendComponent.init=()=>{const e=dom.newTag("section",{class:"resource-timing chart-holder"});e.appendChild(dom.newTag("h3",{text:"Legend"}));const t=dom.newTag("div",{class:"legends-group "});return t.appendChild(createLegend("initiator-type-legend","Initiator Type",[["link","#6bc7b8"],["font","#6ba8c7"],["stylesheet","#6b7ac7"],["JavaScript","#8a6bc7"],["iframe","#b86bc7"],["img","#c78a6b"],["xmlhttprequest","#c76b8a"]])),t.appendChild(createLegend("navigation-legend","Navigation Timing",[["Redirect","#e25336"],["App Cache","#e2a936"],["DNS Lookup","#c5e236"],["TCP","#36e253"],["SSL Negotiation","#36c5e2"],["Time to First Byte","#366fe2"],["Content Download","#9f8fef"],["DOM Processing","#bc63e9"],["DOM Content Loaded","#e236c5"],["On Load","#e2366f"]])),t.appendChild(createLegend("resource-legend","Resource Timing",[["Stalled/Blocking","#ff3344"],["Redirect","#e25336"],["App Cache","#e2a936"],["DNS Lookup","#c5e236"],["TCP","#36e253"],["SSL Negotiation","#36c5e2"],["Initial Connection (TCP)","#36e253"],["Time to First Byte","#366fe2"],["Content Download","#9f8fef"]])),e.appendChild(t),e};const tableComponent={init:()=>{const e=data.requestsOnly.reduce((e,t)=>{let a,n=e[t.fileType];return n||(n=e[t.fileType]={fileType:t.fileType,count:0,initiatorType:{},requestsToHost:0,requestsToExternal:0}),a=n.initiatorType[t.initiatorType],a||(a=n.initiatorType[t.initiatorType]={initiatorType:t.initiatorType,count:0,requestsToHost:0,requestsToExternal:0}),n.count++,a.count++,t.isRequestToHost?(n.requestsToHost++,a.requestsToHost++):(n.requestsToExternal++,a.requestsToExternal++),e},{}),t=dom.newTag("section",{class:"table-section-holder chart-holder"});return t.appendChild(dom.newTag("h1",{text:"Request FileTypes & Initiators"})),t.appendChild(dom.tableFactory("filetypes-and-intiators-table",e=>(["FileType","Count","Count Internal","Count External","Initiator Type","Count by Initiator Type","Initiator Type Internal","Initiator Type External"].forEach(t=>{e.appendChild(dom.newTag("th",{text:t,width:t.indexOf("ternal")>0?"12%":""}))}),e),t=>(Object.keys(e).forEach((a,n)=>{const o=e[a],r=Object.keys(o.initiatorType),i=o.initiatorType[r[0]],l=r.length,s=dom.newTag("tr",{class:"file-type-row "+(o.fileType||"other")+"-light"});[o.fileType,o.count,o.requestsToHost,o.requestsToExternal,i.initiatorType,i.count,i.requestsToHost,i.requestsToExternal].forEach((e,t)=>{const a={text:e};t<4&&r.length>1?a.rowSpan=l:t>=4&&(a.class=(r[0]||"other")+"-light"),s.appendChild(dom.newTag("td",a))}),t.appendChild(s),r.slice(1).forEach(e=>{const a=o.initiatorType[e],n=dom.newTag("tr",{class:"initiator-type-more "+(e||"other")+"-light"});n.appendChild(dom.newTag("td",{text:e})),n.appendChild(dom.newTag("td",{text:a.count})),n.appendChild(dom.newTag("td",{text:a.requestsToHost})),n.appendChild(dom.newTag("td",{text:a.requestsToExternal})),t.appendChild(n)})}),t))),t}},storageKey="performance-bookmarklet-metrics",persistance={},getMetrics=()=>({timestamp:new Date(data.perfTiming.navigationStart).toISOString(),url:window.location.href,requests:data.requestsOnly.length,domains:data.requestsByDomain.length,subDomainsOfTld:data.hostSubdomains,requestsToHost:data.hostRequests,tldAndSubdomainRequests:data.currAndSubdomainRequests,total:data.perfTiming.loadEventEnd-data.perfTiming.navigationStart,timeToFirstByte:data.perfTiming.responseStart-data.perfTiming.navigationStart,domContentLoading:data.perfTiming.domContentLoadedEventStart-data.perfTiming.domLoading,domProcessing:data.perfTiming.domComplete-data.perfTiming.domLoading}),getStoredValues=()=>JSON.parse(localStorage.getItem(storageKey))||[];persistance.persistanceEnabled=()=>!!JSON.parse(localStorage.getItem(storageKey)),persistance.activatePersistance=()=>{persistance.saveLatestMetrics()},persistance.deactivatePersistance=()=>{persistance.dump()},persistance.saveLatestMetrics=()=>{const e=getStoredValues();e.push(getMetrics()),localStorage.setItem(storageKey,JSON.stringify(e))},persistance.dump=(e=!0)=>{const t=getStoredValues();0!==t.length?(!0===e&&(localStorage.removeItem(storageKey),console.log("Storage for %s has been cleared",storageKey)),window.PerformanceBookmarklet={persistedData:t},console.table?(console.log("Data also accessible via %cwindow.PerformanceBookmarklet.persistedData%c:\n\n%o","font-family:monospace","font-family:inherit",window.PerformanceBookmarklet),console.table(t)):(console.log("Data also accessible via window.PerformanceBookmarklet.persistedData"),console.dir(window.PerformanceBookmarklet.persistedData))):console.log("There are no page metrics. Please tick the 'Persist Data' checkbox.")};const tableLogger={};let iFrameEl,outputHolder,outputContent,outputIFrame;tableLogger.logTable=e=>{e.data.length>0&&console.table&&(console.log("\n\n\n"+e.name+":"),console.table(e.data,e.columns))},tableLogger.logTables=e=>{e.forEach(tableLogger.logTable)},tableLogger.logTable({name:"All loaded resources",data:data.allResourcesCalc,columns:["name","domain","fileType","initiatorType","fileExtension","loadtime","isRequestToHost","requestStartDelay","dns","tcp","ttfb","requestDuration","ssl"]}),tableLogger.logTables([{name:"Requests by domain",data:data.requestsByDomain},{name:"Requests by Initiator Type",data:data.initiatorTypeCounts,columns:["initiatorType","count","perc"]},{name:"Requests by Initiator Type (host/external domain)",data:data.initiatorTypeCountHostExt,columns:["initiatorType","count","perc"]},{name:"Requests by File Type",data:data.fileTypeCounts,columns:["fileType","count","perc"]}]);const initHolderEl=()=>{if(outputHolder)for(outputContent=outputIFrame.getElementById("perfbook-content");outputContent.firstChild;)outputContent.removeChild(outputContent.firstChild);else outputHolder=dom.newTag("div",{id:"perfbook-holder"}),outputContent=dom.newTag("div",{id:"perfbook-content"}),outputHolder.appendChild(outputContent)};let addComponent=e=>{outputContent.appendChild(e)};const iFrameHolder={setup:()=>{const e=document.querySelector("[data--=performance]");iFrameEl=dom.newTag("iframe",{id:"perf_report_iframe",onload:()=>{outputIFrame=iFrameEl.contentWindow.document,initHolderEl(),onIFrameReady(addComponent),outputIFrame.body.appendChild(outputHolder),"hidden"!=getComputedStyle(document.body).overflow?iFrameEl.style.height=outputHolder.clientHeight+36+"px":iFrameEl.style.height="100%",e.appendChild(document.adoptNode((iFrameEl.contentDocument.body||iFrameEl.contentDocument).children[0])),iFrameEl.remove()}}),e.appendChild(iFrameEl)},getOutputIFrame:()=>outputIFrame},onIFrameReady=e=>{[summaryTilesComponent.init(),navigationTimelineComponent.init(),pieChartComponent.init(),tableComponent.init(),resourcesTimelineComponent.init(),legendComponent.init(),pageMetricComponent.init()].forEach(t=>{e(t)})};iFrameHolder.setup();